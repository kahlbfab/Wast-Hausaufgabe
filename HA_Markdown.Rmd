---
title: __Hausaufgabe Wast3__
author: "J.Brändli, T.Haas, F.Kahlbacher"
date: "17 Dezember 2018"
header-includes: 
  \usepackage{fancyhdr}
  \addtolength{\headheight}{1cm} 
  \pagestyle{fancyplain} 
  \rhead{\includegraphics[height=1.4cm]{ZHAW.png}} 
  \renewcommand{\headrulewidth}{0.5pt} 
  \renewcommand{\contentsname}{Inhaltsverzeichnis}
  \renewcommand*{\figurename}{Abbildung}

  
output:
  pdf_document: 
    toc: true
    number_sections: yes
    toc_depth: 2
    fig_caption: true
  html_document: default
  word_document: default
---
\newpage

# Einleitung
In diesem Bericht werden aktuelle Luftqualitätsmessungen vom Umwelt- und Gesundheitsschutz der Stadt Zürich untersucht. Der Datensatz, welche von der Datenbank OSTLUFT stammt, enthält unteranderem folgende Messgrössen: Schwefeldioxid (SO2), Kohlenmonoxid (CO), Stickstoffdioxid (NO2), Stickstoffmonoxid (NO), Ozonmengen (O3) und meteorolgische Daten, sowie Feinstaubmessungen (PM10). Vor allem die Feinstaubmessungen sind von Relevanz. Der Feinstaub kann tief in die Lunge eindringen und so schweriwiegende Auswirkungen auf die Gesunheit des Menschen haben. 
Die Messgrössen stammen von den Wetterstationen an der Stampfenbachstrasse, Schimmelstrasse, Heubeeribüelstrasse und der Rosengartenstrasse. 


# __Aufgaben__
```{r, echo=F, results="hide", message=F, error=F, warning=F}
# Alle librarys einlesen
library("tidyr")
library(readr)
require(dplyr, quietly = T)
library(ggplot2)
library(ggpubr)
library(VIM)
library(stringr)
```

## Aufgabe 1
Der Datensatz wird mit dem R-Befehl _read_csv()_ eingelesen. Die eingelesenen Daten werden nun wie gewünscht aufbereitet. Für die Aufbereitung wird unteranderem das R-Packages _dplyr_ verwendet, deshalb muss der eingelesene Datensatz in ein Tibble umgewandelt werden.

```{r, results="hide", message=F, error=F, warning=F}
ugz_luftqualitaetsmessung_seit_2012 <- read_csv("ugz_luftqualitaetsmessung_seit-2012.csv")
luftqualitaet <- as_tibble(ugz_luftqualitaetsmessung_seit_2012)
```



Als nächstes werden die Werte und der Header separiert und in neue Variablen abgespeichert. Dieser Vorgang ist nötig, da der orginale Datensatz mehrere Header-Zeilen (siehe Abbildung 1) enthält, die nicht benötigt werden. Zudem vereinfacht dieser Schritt, die Daten in die gewünschte Form aufbereiten zu können.

<center>
![Header-Zeilen im originalen Datensatz](Header.png)

</center>



```{r, echo=T, results="hide", message=F, error=F, warning=F}
titel <- slice(luftqualitaet, c(2))
titel[1] <- "Datum"
werte <- slice(luftqualitaet, c(-1:-5))
```

\newpage

Es wird von der Variable _werte_ und der Variable _titel_ alle Spalten, die zur gleichen Station gehören (Stampfenbachstrasse, Schimmelstrasse, Heubeerbüel und Rosengarten) separiert und zusammengefügt. So erhält man für jede Station den aufbereiteten Datensatz mit ihren Werten und dem gewünschten Header. Am Schluss werden alle Stationen in die Variable _luftqual_ zusammengefügt.

```{r, echo=T, results="hide", message=F, error=F, warning=F}

stampfenbach <- werte %>% select(1,2:14) %>%
  mutate(Station = "Stampfenbachstrasse")
stampfenbach_titel <- titel %>% select(1,2:14)
stampfenbach_titel[length(stampfenbach)] <- "Station"
names(stampfenbach) <- stampfenbach_titel

schimmel <- werte %>% select(1,15:21) %>%
  mutate(Station = "Schimmelstrasse")
schimmel_titel <- titel %>% select(1,15:21)
schimmel_titel[length(schimmel)] <- "Station"
names(schimmel) <- schimmel_titel

heubeer <- werte %>% select(1,22:25) %>%
  mutate(Station = "Heubeeribüel")
heubeer_titel <- titel %>% select(1,22:25)
heubeer_titel[length(heubeer)] <- "Station"
names(heubeer) <- heubeer_titel

rosengarten <- werte %>% select(1,26:30) %>%   
  mutate(Station = "Rosengarten")
rosengarten_titel <- titel %>% select(1,26:30)
rosengarten_titel[length(rosengarten)] <- "Station"
names(rosengarten) <- rosengarten_titel


# Tabellen zusammensetzen
luftqual <- bind_rows(stampfenbach, schimmel, heubeer, rosengarten)

```

Da das Wetter sich nicht gross zwischen den vier Stationen unterscheidet und es keine näher gelegenen metrologischen Stationen gibt, werden die Wetterdaten der Station Stampfenbachstrasse als Wetterinformation gültig für alle Feinstaubmessstationen. 
```{r, echo=T, results="hide", message=F, error=F, warning=F}
luftqual <- luftqual %>% group_by(Datum) %>% arrange(Datum) %>% 
  fill(Lufttemperatur : Regendauer, .direction = "down") %>% arrange(Station)
```


Als letztes werden alle Messwerte in Typ numeric umgewandlet, damit mit diesen gerechnet werden kann. Der aufbereitete Datensatz ist nun in gewünschter Form und kann für die folgenden Aufgaben verwendet werden.
```{r, echo=T, results="hide", message=F, error=F, warning=F}
luftqual[2:14] <- as_tibble(sapply(luftqual[2:14], as.numeric))
```


## Aufgabe 2
```{r, echo=F, warning=F, fig.height=20, fig.width= 15}
t <- theme(legend.title=element_text(size=17), legend.text=element_text(size=17), 
           axis.title.x = element_text(size = 17), axis.title.y = element_text(size = 17),
           axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15))

# Plots pro Variable
g1 <- ggplot(luftqual, aes(x=Datum, y=Schwefeldioxid)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) + t
g2 <- ggplot(luftqual, aes(x=Datum, y=Kohlenmonoxid)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) + t
g3 <- ggplot(luftqual, aes(x=Datum, y=Stickstoffmonoxid)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) + t
g4 <- ggplot(luftqual, aes(x=Datum, y=Stickstoffdioxid)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) + t
g5 <- ggplot(luftqual, aes(x=Datum, y=`Feinstaub PM10`)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) +t
g6 <- ggplot(luftqual, aes(x=Datum, y=`Ozon, höchstes Stundenmittel`)) + 
  geom_line(aes(color=Station), alpha = 0.75, size = 0.25) + t

# Zusammenfügen der Plots
ggpubr::ggarrange(g1,g2,g3,g4,g5,g6, ncol = 1, nrow = 6, common.legend = TRUE, legend="bottom")
```

\newpage

## Aufgabe 3
```{r, echo=F}
luftqual.A3 <- rapply(luftqual, f=function(x) ifelse(is.nan(x),NA,x), how="replace")
```
Im Datensatz gibt es insgesamt `r sum(is.na(luftqual.A3))` fehlende Werte. 
In untenstehender Grafik ist links der Anteil der fehlenden Werte pro Variable und rechts der Anteil der fehlenden Werte für Kombinationen von Variablen visualisiert.
```{r, echo=F, fig.height=4, fig.width=7, results="hide", warning=F}
names(luftqual.A3) <- c("Datum", "SO2", "CO", "O3_max_h1", "O3_nb_h1>120",
                        "NO2", "NO", "PM10", "T", "Hr", "p", "WVS", "StrGlo", "RainDur", "Station")

par(mar= c(4,2,2,6))
aggr_plot <- aggr(luftqual.A3, col=c('navyblue','red'), 
                  numbers = TRUE, sortVars=TRUE, labels=names(luftqual.A3),
                  cex.axis=0.7, gap=0.5,
                  ylab=c("Histogram of missing data","Pattern"), cex.lab = 1)
dev.off()
```

Der Anteil der fehlenden Werte pro Variable ist für _SO2_ am grössten. Er liegt bei etwa 0.6, dicht gefolgt von _CO_ mit 0.58 und _PM10_ mit 0.34. 

Der Anteil der fehlenden Werte für Kombinationen von Variablen ist schwieriger zu lesen. Die meiste Kombination tritt auf, wenn alle Daten (keine NAs) vorhanden sind. Die zweitmeiste Kombination tritt auf, wenn für SO2, CO2 und PM10 Werte fehlen und alle anderen Variablen keine NAs enthalten. 

\newpage

## Aufgabe 4
In dieser Aufgabe ist die Variable Feinstaub (PM10) von Interesse, jeweils für die Messpunkte Stampfenbachstrasse, Schimmelstrasse und Rosengartenstrasse. Heubeeribüel hat keine Messungen des Feinstaubes und wird darum nicht berücksichtigt.  

Der Tagesmittelgrenzwert vom PM10 beträgt 50ug/m^3 und darf max. 1x pro Jahr ueberschritten werden.  

Daten vorbereiten:
```{r, tidy=T}
luftqual.PM10 <- luftqual %>% ungroup() %>%
  select(Datum, 'Feinstaub PM10', Station) %>%  # nur relevante Kolumnen
  filter(Station != "Heubeeribüel") %>%
  mutate(PM10_uberschritt = `Feinstaub PM10` >= 50 )

head(luftqual.PM10)
```
Die ersten 6 Werte sind per Zufall gerade NA. 


### Wie oft wird der Tagesmittel-Grenzwert an welcher Station überschritten?
```{r}
luftqual.PM10 %>% group_by(Station) %>% summarize(n = sum(PM10_uberschritt, na.rm = T))
```
An der Schimmelstrasse wird der Tagesmittel-Grenzwert am häufigsten überschritten.
\newpage  

### Überschrittenen Tagesmittelgrenzwerte im Zeitlichen verlauf für alle Stationen in einer Grafik
```{r, fig.height=4, fig.width=7}
luftqual.PM10 %>% filter(PM10_uberschritt) %>% 
  ggplot(aes(x=Datum, y=`Feinstaub PM10`)) + geom_point(aes(color = Station)) + ggtitle(" Überschrittene Tagesmittelgrenzwerte (PM10 > 50)")
```

Der Tagesmittelgrenzwert wird bei allen Stationen oft in den gleichen Wochen / Monaten uebertroffen. Dies ist gut moeglich, da alle Messstationen ähnlichen Einflüssen ausgesetzt sind, auf welche der Feinstaub reagiert. Wie z.B. die Jahreszeit und das Wetter.

Aus der Grafik ist ersichtlich, dass die Feinstaubbelastung im Winter höher ist, als in den anderen Jahreszeiten.

### In welchen Jahren und Stationen ist der Anteil der Tage mit Grenzwert uberschreitungen signifikant groesser als zufaellig

Jahresmittelgrenzwert = 20ug/m^3

Daten vorbereiten: Nach dem Jahr und Station gruppieren
```{r}
luftqual.PM10 <- luftqual.PM10 %>% mutate(Jahr = strtrim(luftqual.PM10$Datum, 4)) %>%
  group_by(Jahr, Station) %>%
  summarize(n = sum(PM10_uberschritt, na.rm = T))

head(luftqual.PM10)

# pairwise wilcox test
# pairwise.wilcox.test(luftqual.PM10$n, luftqual.PM10$Jahr, luftqual.PM10$Station)
```

## Aufgabe 5
Visualisierung des Zusammenhanges zwischen der Regenmenge und der Feinstaubkonzentration pro Station. 
```{r, fig.height=4,fig.width=7, warning=F}
ordered_PM10 <- select(luftqual, Datum, `Feinstaub PM10`, Station, Regendauer)
  
# Plot
ggplot(ordered_PM10, aes(x= Regendauer, y= `Feinstaub PM10`)) +
  geom_point(aes(color = Station),  alpha = 0.5, size = 0.8)
```

Auf der Grafik ist folgendes Verhalten zu erkennen: Die Feinstaubkonzentration ist tendenziell höher wenn es nicht Regnet, als wenn es Regnet. Um so länger es Regnet, nimmt dieser Effekt noch zu. 
\newpage  

Mit einem Statistischen Test soll überprüft werden, ob ein Zusammenhang besteht. Es wurde der t-Test verwendet, da die Mittelwerte der Feinstaubkonzentration normalverteilt aber die Varianz nicht bekannt sind. 

h0: mu_Feinstaub_regen = mu_Feinstaub_keinregen  
h1: mu_Feinstaub_regen < mu_Feinstaub_keinregen
```{r}
PM10_test <- ordered_PM10 %>% group_by(Datum) %>%
  summarise(PM10_mean = mean(`Feinstaub PM10`, na.rm = T) ,
            Regendauer = Regendauer[1])

# tTest
t.test(x = PM10_test$PM10_mean[PM10_test$Regendauer != 0], 
       y = PM10_test$PM10_mean[PM10_test$Regendauer == 0],
       conf.level = 0.99, alternative = "less")
```
p < 0.01 --> h0 verwerfen  

Die Nullhypothese wird klar verworfen. Das heisst, die Feinstaubkonzentration ist an Tagen mit Regen signifikant tiefer als an Tagen mit Regen. 


## Aufgabe 6


# __Fazit__





